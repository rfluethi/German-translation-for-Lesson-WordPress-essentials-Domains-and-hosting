name: Create and upload ZIP files for release

on:
  release:
    types: [created]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  zip_and_upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Setup Git LFS
        run: |
          git lfs install
          git lfs pull

      - name: Debug - Show file sizes
        run: |
          echo "=== Checking file sizes ==="
          echo "Main video file:"
          ls -lh media/video/video-v-0-02-00.mp4 || echo "Video file not found"
          echo ""
          echo "LFS status:"
          git lfs ls-files | head -5
          echo ""
          echo "Directory contents:"
          find media/video -type f -exec ls -lh {} \;

      # Create docs ZIP
      - name: Create docs ZIP
        run: |
          mkdir -p zip
          if [ -d "docs" ] && [ "$(ls -A docs)" ]; then
            echo "Creating ZIP for documents..."
            zip -r zip/tutorial-docs.zip docs
            echo "Docs ZIP created: $(ls -lh zip/tutorial-docs.zip)"
          else
            echo "Docs directory is empty or missing. Skipping ZIP creation."
          fi

      # Create assets ZIP
      - name: Create assets ZIP
        run: |
          if [ -d "src" ] && [ "$(ls -A src)" ]; then
            echo "Creating ZIP for assets..."
            zip -r zip/tutorial-assets.zip src
            echo "Assets ZIP created: $(ls -lh zip/tutorial-assets.zip)"
          else
            echo "Source directory is empty or missing. Skipping ZIP creation."
          fi

      # Create videos ZIP with LFS verification
      - name: Create videos ZIP
        run: |
          if [ -d "media/video" ] && [ "$(ls -A media/video)" ]; then
            echo "Creating ZIP for videos..."
            echo "Video files to include:"
            find media/video -type f -exec ls -lh {} \;
            zip -r zip/tutorial-videos.zip media/video
            echo "Videos ZIP created: $(ls -lh zip/tutorial-videos.zip)"
            echo "ZIP contents:"
            unzip -l zip/tutorial-videos.zip | head -10
          else
            echo "Video directory is empty or missing. Skipping ZIP creation."
          fi

      # Debug - Show all ZIP files
      - name: Debug - Show ZIP files
        run: |
          echo "=== Final ZIP files ==="
          ls -la zip/ || echo "No zip directory found"
          if [ -d "zip" ]; then
            for zipfile in zip/*.zip; do
              if [ -f "$zipfile" ]; then
                echo "ZIP file: $zipfile"
                echo "Size: $(ls -lh "$zipfile")"
                echo "Contents:"
                unzip -l "$zipfile" | head -5
                echo "---"
              fi
            done
          fi

      # Upload ZIP files when triggered by a release
      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: zip/*.zip
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Upload ZIP files when manually triggered
      - name: Upload Artifact
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: tutorial-zips
          path: zip/*.zip
